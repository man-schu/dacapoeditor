<!DOCTYPE html>

<!-- uses filesaver: https://eligrey.com/demos/FileSaver.js/
https://stackoverflow.com/questions/50126062/how-to-use-filesaver-js-to-save-text-files -->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="author" content="Manfred Schulenburg">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet" type="text/css" media="screen">
  <link rel="icon" href="favicon.ico" type="image/x-icon"/>
  <title>MusEdit - ABC Music Editor</title>
  <link rel="stylesheet" type="text/css" href="abcjs-audio.css">
  <script src="abcjs-basic-min.js" type="text/javascript"></script>
  <script src="functions.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="FileSaver.min.js"></script>
	
  <script type="text/javascript">
    var abcjsEditor;

    window.onload = function () {
      abcjsEditor = new ABCJS.Editor("abc", {
        canvas_id: "paper",
        warnings_id: "warnings",
        synth: {
          el: "#audio",
          options: { displayLoop: true, displayRestart: true, displayPlay: true, displayProgress: true, displayWarp: true }
        },
        abcjsParams: {
          add_classes: true,
          clickListener: clickListener
        },
        selectionChangeCallback: selectionChangeCallback
      });
    };

    function clickListener(abcElem, tuneNumber, classes, analysis, drag, mouseEvent) {
      var lastClicked = abcElem.midiPitches;
      if (!lastClicked)
        return;

      ABCJS.synth.playEvent(lastClicked, abcElem.midiGraceNotePitches, abcjsEditor.millisecondsPerMeasure()).then(function (response) {
        console.log("note played");
      }).catch(function (error) {
        console.log("error playing note", error);
      });
    }

    function selectionChangeCallback(start, end) {
      if (abcjsEditor) {
        var el = abcjsEditor.tunes[0].getElementFromChar(start);
        console.log(el);
      }
    }
  </script>	
  <style>
    @media print {
      header, footer, nav button, button, main section {
        display: none;
      }
      main section.output {
        display: block;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>MusEdit - ABC Music Editor</h1>
  </header>   
<main>

  <section>
     <div class="infobox"> <p>Abcjs is a Javascript based music notation renderer which can be easily integrated in html files. 
     The main website is <a href="https://www.abcjs.net/">https://www.abcjs.net/</a>. Abcjs can be downloaded for free on Github: 
     <a href="https://github.com/paulrosen/abcjs/">https://github.com/paulrosen/abcjs</a>.</p>
  <p>Here is an example. You can modify the code in the coding area for testing purposes. 
  Note that it won't be saved when you refresh the page. Nevertheless, if you host your own 
  page, you can simply copy and paste the code in the coding area into your html file.</p></div>
  <br><br><br>
  </section>
  <div class="row">
    <div class="column left">
	    
	    
      <section>
	  <input class="centered" type="file">

	      <p>When loading an abc file, click in the text area to refresh the music sheet.</p>
	      <p>Observe that the music sheet will not refresh if the abc file contains errors.</p>
	  <br>    
    <textarea class="input" id="abc" cols="80" rows="25" spellcheck="false">
X: 1
T: Menuett in G-Dur
C: Christian Petzold
O: 1677 - 1733
P: aus dem Notenbüchlein für Anna Magdalena Bach
M: 3/4
L: 1/8
K: C
%%measurenb 0
!f! G2 CD EF|G2 C2 C2|A2 FG AB|c2 C2 C2|F2 GF ED|
E2 FE DC|B,2 CD EC|D4>|G4 CD EF|!p!G2 C2 C2|A2 FG AB|
c2 C2 C2 |F2 GF ED|E2 FE DC|D2 ED CB, C4||

    
    </textarea>
	      	      <span id="warnings"></span>
	      <br>
        <button id="button" onclick="download();">save abc file</button>

        <script type="text/javascript">
            function download() {
  var save = document.getElementById("abc").value;
  var blob = new Blob([save], {
    type: "text/plain;charset=utf-8"
  });
  saveAs(blob, "sample-file.abc");
}
        </script>
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<!-- <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/5ed507ef8aa53d8ecfea96d96bc7214cd2476fd2/FileSaver.min.js"></script> -->
	      
	      
<!--	      <div class="popup" onclick="myFunction()"><button>Info</button>
  <span class="popuptext" id="myPopup">Please note that the functionality to save a file to the file system will only work on the stand-alone desktop app, not on the website version.<br>However, in case you prefer using the website based application, you can still copy and paste to a normal text file.</span>
 </div> -->
	      
	      <br><br>
	     

  <span id="audio"></span>
<br>

  </section>
          </div>
      <div class="column right">
	    <section>
    <button class="button" onclick="window.print()"><i class="fa fa-print" aria-hidden="true"></i> Print music sheet</button>
  </section>
 <section class="output">

   <span id="paper"></span>   
 </section>

    </div>
  </div>
  </main>
  <script src="import.js"></script>

</body>
</html>
